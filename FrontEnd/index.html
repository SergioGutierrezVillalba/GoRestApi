<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>Websocket Test</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <script src="https://code.jquery.com/jquery-3.3.1.js"
        integrity="sha256-2Kok7MbOyxpgUVvAk/HJ2jigOSYS2auK4Pfzbm7uH60=" crossorigin="anonymous"></script>
</head>

<body>

    <input type="text" id="username">
    <input type="password" name="" id="password">

    First: <button onclick="login()">Loguearse</button>

    <input type="text" autocomplete="off" id="input">
    Second:<button id="send">Start WebSocket</button>

    <br>
    <br>

    Third: <button onclick="getMe()">Get ME</button>
    <!-- Charge the user info to see
    <p id="usernameInfo"></p>
    <p id="usernameGroupId"></p> -->

    Fourth: <button onclick="startTimer()">StartTimer</button>

    <br>
    <br>

    Fifth : <button onclick="finishTimer()">FinishTimer</button>

    <br>

    <div id="userinfo" style="display:inline-block; width:50%">
        <h2>User info</h2>
    </div>

    <div id="times" style="display:inline-block; width:50%">
        <h2>Times info</h2>
    </div>

    <script>

        var button = document.querySelector('#send');
        
        let ws = new WsClient('ws://localhost:3003/ws')
        ws.on('response', (data) => {
            console.log('response: ', data)
        })

        // ws.on('close', () => {
        //     $.ajax({
        //         type: "POST",
        //         url: urlGnommo + "/users/login",
        //         data: JSON.stringify(user),
        //         success: function (data) {
        //             token = data.token
        //             logged = true
        //             ws.emit('message', token);
        //             console.log("logged")
        //         },
        //         error: function (xhr, status, error) {
        //             var err = JSON.parse(xhr.responseText);
        //             console.log(err)
        //         }
        //     })
        // })

        button.onclick = () => {
            ws.emit('message', token);
        }


        let logged = false;
        let token = "";
        let urlGnommo = "http://192.168.1.32:3003";
        let urlHome = "http://192.168.1.149:3003";
        let me = "";
        let timerIdToStop = "";
        let finishedTime = "";

        class User {
            constructor(username, password, groupId = "", userId = "") {
                this.username = username;
                this.password = password;
                this.groupId = groupId;
                this.id = userId;
            }

            getUsername() {
                return this.username
            }

            setUsername(username) {
                this.username = username;
            }
        }


        function login() {
            let username = document.getElementById("username")
            let password = document.getElementById("password")
            let user = new User(username.value, password.value)

            $.ajax({
                type: "POST",
                url: urlGnommo + "/users/login",
                data: JSON.stringify(user),
                success: function (data) {
                    token = data.token
                    logged = true
                    ws.emit('message', token);
                    console.log("logged")
                },
                error: function (xhr, status, error) {
                    var err = JSON.parse(xhr.responseText);
                    console.log(err)
                }
            })
        }
        function storeMe(data){
            me = new User(data.username, "", data.groupId, data.id)
        }
        function getMe(){
            $.ajax({
                type: "GET",
                url: urlGnommo + "/user",
                headers: {
                    'Authorization':'Bearer ' + token
                },
                success: function (data){
                    storeMe(data);
                    content = "User: " + data.username + " | " + " GroupId: " + data.groupId 
                    document.getElementById("userinfo").append(
                        document.createElement('p').textContent = content
                    )
                    console.log("(GetMe): Done")
                },
                error: function (xhr, status, error) {
                    var err = JSON.parse(xhr.responseText);
                    console.log(err)
                }
            })
        }

        function startTimer(){
            $.ajax({
                type: 'POST',
                url: urlGnommo + "/timers/start",
                headers: {
                    'Authorization':'Bearer ' + token
                },
                data: JSON.stringify(me),
                contentType: 'application/json',
                dataType: 'json',
                success: function (data){
                    timerIdToStop = data.id

                    timesDiv = document.getElementById("times");
                    timesDiv.append(
                        document.createElement('p').textContent = data.Start
                    );
                    timesDiv.append(document.createElement('br'));  
                    console.log("(StartTimer): Timer started")
                },
                error: function (xhr, status, error) {
                    var err = JSON.parse(xhr.responseText);
                    console.log(err)
                }
            })
        }

        function finishTimer(){
            $.ajax({
                type: 'POST',
                url: urlGnommo + "/timers/finish",
                headers: {
                    'Authorization':'Bearer ' + token
                },
                data: JSON.stringify({id: timerIdToStop}),
                contentType: 'application/json',
                dataType: 'json',
                success: function (data){
                    console.log(data)
                    finishedTime = data.finish

                    document.getElementById("times").append(
                        document.createElement('p').textContent = finishedTime
                    )

                },
                error: function (xhr, status, error) {
                    var err = JSON.parse(xhr.responseText);
                    console.log(err)
                }
            })
        }

        function WsClient(url) {
            this.ws = new WebSocket(url);
            this.eventListener = {};
            this.on = (event, cb) => this.eventListener[event] = cb;
            this.emit = (name, data) => {
                let event = {
                    event: name,
                    data: data,
                }
                let rawData = JSON.stringify(event);
                this.ws.send(rawData);
            }
            this.ws.onmessage = (response) => {
                try {
                    let data = JSON.parse(response.data);
                    if (data) {
                        let cb = this.eventListener[data.event]
                        if (cb)
                            cb(data.data)
                    }
                } catch (e) {
                    console.log(e)
                }
            }
        }

    </script>

</body>

</html>